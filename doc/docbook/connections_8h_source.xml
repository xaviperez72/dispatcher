<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<section xmlns="http://docbook.org/ns/docbook" version="5.0" xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="_connections_8h_source" xml:lang="en-US">
<title>connections.h</title>
<indexterm><primary>src/connections.h</primary></indexterm>
Go to the documentation of this file.<programlisting linenumbering="unnumbered"><anchor xml:id="_connections_8h_source_1l00001"/>00001 <emphasis role="preprocessor">#ifndef&#32;CONNECTIONS_H</emphasis>
<anchor xml:id="_connections_8h_source_1l00002"/>00002 <emphasis role="preprocessor">#define&#32;CONNECTIONS_H</emphasis>
<anchor xml:id="_connections_8h_source_1l00003"/>00003 
<anchor xml:id="_connections_8h_source_1l00004"/>00004 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_common_8h">common.h</link>&quot;</emphasis>
<anchor xml:id="_connections_8h_source_1l00005"/>00005 <emphasis role="preprocessor">#include&#32;&lt;sys/socket.h&gt;</emphasis>
<anchor xml:id="_connections_8h_source_1l00006"/>00006 <emphasis role="preprocessor">#include&#32;&lt;netinet/in.h&gt;</emphasis>
<anchor xml:id="_connections_8h_source_1l00007"/>00007 <emphasis role="preprocessor">#include&#32;&lt;string&gt;</emphasis>
<anchor xml:id="_connections_8h_source_1l00008"/>00008 <emphasis role="preprocessor">#include&#32;&lt;algorithm&gt;</emphasis>
<anchor xml:id="_connections_8h_source_1l00009"/>00009 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_ipclib_8h">ipclib.h</link>&quot;</emphasis>
<anchor xml:id="_connections_8h_source_1l00010"/>00010 
<anchor xml:id="_connections_8h_source_1l00011"/><link linkend="_connections_8h_1aede8a714e0f79ef4a61e79c2e30f607c">00011</link> <emphasis role="keyword">constexpr</emphasis>&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_connections_8h_1aede8a714e0f79ef4a61e79c2e30f607c">st_free</link>{0};
<anchor xml:id="_connections_8h_source_1l00012"/><link linkend="_connections_8h_1a7cfb338d62be51e2990fb43cb27573a1">00012</link> <emphasis role="keyword">constexpr</emphasis>&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_connections_8h_1a7cfb338d62be51e2990fb43cb27573a1">st_ready</link>{2};
<anchor xml:id="_connections_8h_source_1l00013"/><link linkend="_connections_8h_1a841c1992874382f999f316fa8162c520">00013</link> <emphasis role="keyword">constexpr</emphasis>&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_connections_8h_1a841c1992874382f999f316fa8162c520">st_obsolete</link>{3};
<anchor xml:id="_connections_8h_source_1l00017"/><link linkend="_structconnection">00017</link> <emphasis role="keyword">struct&#32;</emphasis><link linkend="_structconnection">connection</link>{
<anchor xml:id="_connections_8h_source_1l00018"/><link linkend="_structconnection_1a392dff3ac59ae78e0cbe5880c150cda6">00018</link> &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_structconnection_1a392dff3ac59ae78e0cbe5880c150cda6">next_info</link>{0};&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Next&#32;free&#32;connection</emphasis>
<anchor xml:id="_connections_8h_source_1l00019"/><link linkend="_structconnection_1ae8b8ce14b8384cbff2724f003e23e856">00019</link> &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_structconnection_1ae8b8ce14b8384cbff2724f003e23e856">nthread</link>{0};&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;idx&#32;of&#32;thread&#32;pair.</emphasis>
<anchor xml:id="_connections_8h_source_1l00020"/><link linkend="_structconnection_1a425254df6cac48b837b9991b9df86c6f">00020</link> &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_structconnection_1a425254df6cac48b837b9991b9df86c6f">status</link>{<link linkend="_connections_8h_1aede8a714e0f79ef4a61e79c2e30f607c">st_free</link>};&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;connection&#32;status&#32;</emphasis>
<anchor xml:id="_connections_8h_source_1l00021"/><link linkend="_structconnection_1aaf5e92500e5f396f4e1e1b70b01168a1">00021</link> &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_structconnection_1aaf5e92500e5f396f4e1e1b70b01168a1">sd</link>{-1};&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Socket&#32;descriptor</emphasis>
<anchor xml:id="_connections_8h_source_1l00022"/><link linkend="_structconnection_1ad9e7923a71fc9ed30f01d893f340bb33">00022</link> &#32;&#32;&#32;&#32;sockaddr_in&#32;<link linkend="_structconnection_1ad9e7923a71fc9ed30f01d893f340bb33">sockaddr</link>{};&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;IP:port&#32;info</emphasis>
<anchor xml:id="_connections_8h_source_1l00023"/><link linkend="_structconnection_1aa8a98f765771cd8af05864e34838fc04">00023</link> &#32;&#32;&#32;&#32;time_t&#32;<link linkend="_structconnection_1aa8a98f765771cd8af05864e34838fc04">entry</link>{};&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;time&#32;of&#32;1st&#32;operation&#32;entry</emphasis>
<anchor xml:id="_connections_8h_source_1l00024"/><link linkend="_structconnection_1ac578f0ac27bbd5879f0462fa2517d39c">00024</link> &#32;&#32;&#32;&#32;time_t&#32;<link linkend="_structconnection_1ac578f0ac27bbd5879f0462fa2517d39c">last_op</link>{};&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;time&#32;of&#32;last&#32;operation.</emphasis>
<anchor xml:id="_connections_8h_source_1l00025"/><link linkend="_structconnection_1a1d7e91ee2dab6b52781880669e9e38d6">00025</link> &#32;&#32;&#32;&#32;<emphasis role="keywordtype">long</emphasis>&#32;<link linkend="_structconnection_1a1d7e91ee2dab6b52781880669e9e38d6">num_ops</link>{0};&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Number&#32;of&#32;processed&#32;operations.&#32;</emphasis>
<anchor xml:id="_connections_8h_source_1l00026"/>00026 };
<anchor xml:id="_connections_8h_source_1l00027"/>00027 
<anchor xml:id="_connections_8h_source_1l00031"/><link linkend="_classconnections">00031</link> <emphasis role="keyword">class&#32;</emphasis><link linkend="_classconnections">connections</link>{
<anchor xml:id="_connections_8h_source_1l00032"/><link linkend="_classconnections_1aa422d2929a142e3b88a0035c10ea2799">00032</link> &#32;&#32;&#32;&#32;<emphasis role="keywordtype">bool</emphasis>&#32;<link linkend="_classconnections_1aa422d2929a142e3b88a0035c10ea2799">initialized</link>{<emphasis role="keyword">false</emphasis>};&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Is&#32;it&#32;initialized?</emphasis>
<anchor xml:id="_connections_8h_source_1l00033"/><link linkend="_classconnections_1a4ef1805523e87bc105015afcce456dc4">00033</link> &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_classconnections_1a4ef1805523e87bc105015afcce456dc4">first_free</link>{0};&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;First&#32;free&#32;connection&#32;entry.&#32;</emphasis>
<anchor xml:id="_connections_8h_source_1l00034"/><link linkend="_classconnections_1a48e53d849d45c221c4bc1b4df8013a13">00034</link> &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_classconnections_1a48e53d849d45c221c4bc1b4df8013a13">nThreads</link>{0};&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Number&#32;of&#32;thread&#32;pairs&#32;running.&#32;</emphasis>
<anchor xml:id="_connections_8h_source_1l00035"/><link linkend="_classconnections_1ab8405116666865cf960deb54b6beb2c9">00035</link> &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_classconnections_1ab8405116666865cf960deb54b6beb2c9">MaxConn</link>{0};&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Max&#32;number&#32;of&#32;connections.&#32;</emphasis>
<anchor xml:id="_connections_8h_source_1l00036"/><link linkend="_classconnections_1aec431699f4e5f15397d398150b97222b">00036</link> &#32;&#32;&#32;&#32;<link linkend="_structconnection">connection</link>&#32;*<link linkend="_classconnections_1aec431699f4e5f15397d398150b97222b">current_connections</link>{<emphasis role="keyword">nullptr</emphasis>};&#32;&#32;&#32;<emphasis role="comment">//&#32;Pointer&#32;to&#32;the&#32;connection&#32;array.</emphasis>
<anchor xml:id="_connections_8h_source_1l00037"/>00037 
<anchor xml:id="_connections_8h_source_1l00038"/>00038 <emphasis role="keyword">public</emphasis>:
<anchor xml:id="_connections_8h_source_1l00045"/>00045 &#32;&#32;&#32;&#32;<link linkend="_classconnections">connections</link>(<emphasis role="keywordtype">int</emphasis>&#32;MaxConnections,&#32;<emphasis role="keywordtype">int</emphasis>&#32;NumThreads);
<anchor xml:id="_connections_8h_source_1l00046"/>00046 &#32;&#32;&#32;&#32;
<anchor xml:id="_connections_8h_source_1l00047"/>00047 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Marks&#32;a&#32;connection&#32;as&#32;obsolete&#32;(st_obsolete=3)&#32;on&#32;the&#32;idx&#32;position&#32;of&#32;the&#32;connection&#32;array</emphasis>
<anchor xml:id="_connections_8h_source_1l00048"/>00048 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_classconnections_1abd2f1b462739513f2c23236fb28b08a8">mark_obsolete</link>(<emphasis role="keywordtype">int</emphasis>&#32;idx);
<anchor xml:id="_connections_8h_source_1l00049"/>00049 &#32;&#32;&#32;&#32;
<anchor xml:id="_connections_8h_source_1l00050"/>00050 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Marks&#32;a&#32;connection&#32;as&#32;free&#32;(st_obsolete=3)&#32;on&#32;the&#32;idx&#32;position&#32;of&#32;the&#32;connection&#32;array</emphasis>
<anchor xml:id="_connections_8h_source_1l00051"/>00051 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_classconnections_1aba8db6b2f3d43d4a030b764fb2371b6a">delete_obsolete</link>(<emphasis role="keywordtype">int</emphasis>&#32;idx);
<anchor xml:id="_connections_8h_source_1l00052"/>00052 &#32;&#32;&#32;
<anchor xml:id="_connections_8h_source_1l00059"/>00059 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_classconnections_1aa8c930db3c4885c33de249f67c6f3ca6">clean_repeated_ip</link>(sockaddr_in&#32;*ppal,&#32;<link linkend="_classSemaphore">Semaphore</link>&#32;&amp;sem);
<anchor xml:id="_connections_8h_source_1l00060"/>00060 &#32;&#32;&#32;
<anchor xml:id="_connections_8h_source_1l00069"/>00069 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_classconnections_1a94f933faea3ade69fc63ecd8647d5423">register_new_conn</link>(<emphasis role="keywordtype">int</emphasis>&#32;nthread,&#32;<emphasis role="keywordtype">int</emphasis>&#32;sd,&#32;sockaddr_in&#32;s_in,&#32;<link linkend="_classSemaphore">Semaphore</link>&#32;&amp;sem);
<anchor xml:id="_connections_8h_source_1l00070"/>00070 &#32;&#32;&#32;
<anchor xml:id="_connections_8h_source_1l00077"/>00077 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_classconnections_1a7818be12aec98b6c015b038b667c568f">unregister_conn</link>(<emphasis role="keywordtype">int</emphasis>&#32;idx,&#32;<link linkend="_classSemaphore">Semaphore</link>&#32;&amp;sem);
<anchor xml:id="_connections_8h_source_1l00078"/>00078 &#32;&#32;&#32;&#32;
<anchor xml:id="_connections_8h_source_1l00086"/>00086 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_classconnections_1abad7f85b1ef27d0417c4571b905192b1">ending_operation</link>(<emphasis role="keywordtype">int</emphasis>&#32;idx,&#32;<link linkend="_classSemaphore">Semaphore</link>&#32;&amp;sem,&#32;<link linkend="_structconnection">connection</link>&#32;&amp;cur_conn);
<anchor xml:id="_connections_8h_source_1l00087"/>00087 &#32;&#32;&#32;&#32;
<anchor xml:id="_connections_8h_source_1l00094"/>00094 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_classconnections_1a9dd3e4b0392c9eddcdbc2df69071145c">check_obsolete</link>(<emphasis role="keywordtype">int</emphasis>&#32;idx_con,&#32;<link linkend="_classSemaphore">Semaphore</link>&#32;&amp;sem);
<anchor xml:id="_connections_8h_source_1l00095"/>00095 
<anchor xml:id="_connections_8h_source_1l00096"/><link linkend="_classconnections_1a1d163bdeb5127186898ab71987ef6dc5">00096</link> &#32;&#32;&#32;&#32;<emphasis role="keywordtype">bool</emphasis>&#32;<link linkend="_classconnections_1a1d163bdeb5127186898ab71987ef6dc5">is_all_connections_done</link>()&#32;{&#32;
<anchor xml:id="_connections_8h_source_1l00097"/>00097 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;!std::any_of(&amp;(<link linkend="_classconnections_1aec431699f4e5f15397d398150b97222b">current_connections</link>[0]),&amp;(<link linkend="_classconnections_1aec431699f4e5f15397d398150b97222b">current_connections</link>[<link linkend="_classconnections_1ab8405116666865cf960deb54b6beb2c9">MaxConn</link>-1]),[](<link linkend="_structconnection">connection</link>&#32;c){<emphasis role="keywordflow">return</emphasis>&#32;c.<link linkend="_structconnection_1a425254df6cac48b837b9991b9df86c6f">status</link>==<link linkend="_connections_8h_1a7cfb338d62be51e2990fb43cb27573a1">st_ready</link>;}&#32;);
<anchor xml:id="_connections_8h_source_1l00098"/>00098 &#32;&#32;&#32;&#32;}
<anchor xml:id="_connections_8h_source_1l00099"/>00099 };
<anchor xml:id="_connections_8h_source_1l00100"/>00100 &#32;&#32;&#32;&#32;
<anchor xml:id="_connections_8h_source_1l00101"/>00101 
<anchor xml:id="_connections_8h_source_1l00102"/>00102 <emphasis role="preprocessor">#endif</emphasis>
</programlisting></section>
